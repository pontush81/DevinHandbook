import React, { useState, useCallback, useRef, memo, useEffect } from 'react';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { Badge } from '@/components/ui/badge';
import { Progress } from '@/components/ui/progress';
import { 
  Upload, 
  FileText, 
  Brain, 
  CheckCircle, 
  AlertCircle, 
  Loader2,
  BookOpen,
  Download,
  Info
} from 'lucide-react';
import { showToast } from '@/components/ui/use-toast';
import { DEFAULT_HANDBOOK_TEMPLATE } from '@/lib/handbook-templates';
import { handbookStorage } from '@/lib/safe-storage';

interface ImportedSection {
  title: string;
  content: string;
  confidence: number;
  suggestedMapping?: string;
}

interface DocumentImportProps {
  onImportComplete: (sections: ImportedSection[]) => void;
  onImportStatusChange?: (status: { hasFile: boolean; isAnalyzing: boolean; hasResults: boolean }) => void;
  isLoading?: boolean;
}

interface AnalysisResult {
  sections: ImportedSection[];
  metadata: {
    title: string;
    totalPages: number;
    language: string;
    documentType: string;
  };
}

// Memoize the component to prevent unnecessary re-renders
export const DocumentImport = memo(function DocumentImport({ onImportComplete, onImportStatusChange, isLoading = false }: DocumentImportProps) {
  const [files, setFiles] = useState<File[]>([]);
  const [dragActive, setDragActive] = useState(false);
  const [isAnalyzing, setIsAnalyzing] = useState(false);
  const [analysisStep, setAnalysisStep] = useState('');
  const [analysisProgress, setAnalysisProgress] = useState(0);
  const [analysisResult, setAnalysisResult] = useState<AnalysisResult | null>(null);
  const [error, setError] = useState<string | null>(null);
  const [currentFileIndex, setCurrentFileIndex] = useState(0);
  const [isResultsCollapsed, setIsResultsCollapsed] = useState(false);
  
  // AnvÃ¤nd useRef fÃ¶r att fÃ¶rhindra onÃ¶diga re-renders och bevara state
  const fileInputRef = useRef<HTMLInputElement>(null);
  const isProcessingRef = useRef(false);
  const analysisResultRef = useRef<AnalysisResult | null>(null);
  const filesRef = useRef<File[]>([]);
  
  // Synkronisera state med refs fÃ¶r att bevara vid fÃ¶nsterbyte
  useEffect(() => {
    analysisResultRef.current = analysisResult;
  }, [analysisResult]);
  
  useEffect(() => {
    filesRef.current = files;
  }, [files]);
  
  // Spara state till localStorage nÃ¤r det Ã¤ndras
  useEffect(() => {
    if (analysisResult) {
      const success = handbookStorage.saveDocumentImportState(analysisResult);
      if (success) {
        console.log('ðŸ’¾ Sparar document import state till localStorage');
      }
    }
  }, [analysisResult]);
  
  // Ã…terstÃ¤ll state frÃ¥n localStorage vid komponentstart
  useEffect(() => {
    const savedData = handbookStorage.getDocumentImportState();
    if (savedData) {
      const { analysisResult: savedAnalysisResult, timestamp } = savedData;
      const now = Date.now();
      const fifteenMinutes = 15 * 60 * 1000; // 15 minuter i millisekunder
      
      // Ã…terstÃ¤ll endast om det Ã¤r mindre Ã¤n 15 minuter sedan
      if (now - timestamp < fifteenMinutes && savedAnalysisResult) {
        console.log('ðŸ”„ Ã…terstÃ¤ller document import state frÃ¥n localStorage');
        setAnalysisResult(savedAnalysisResult);
        analysisResultRef.current = savedAnalysisResult;
        
        // Meddela parent om Ã¥terstÃ¤lld status
        if (onImportStatusChange) {
          onImportStatusChange({
            hasFile: true,
            isAnalyzing: false,
            hasResults: true
          });
        }
        
        // Trigga onImportComplete om det finns sektioner
        if (savedAnalysisResult.sections && savedAnalysisResult.sections.length > 0) {
          onImportComplete(savedAnalysisResult.sections);
        }
      }
    }
  }, [onImportComplete, onImportStatusChange]);
  
  // Ã…terstÃ¤ll state vid fÃ¶nsterbyte
  useEffect(() => {
    const handleVisibilityChange = () => {
      if (!document.hidden) {
        // Ã…terstÃ¤ll analysisResult frÃ¥n ref om det fÃ¶rsvunnit
        if (!analysisResult && analysisResultRef.current) {
          console.log('ðŸ”„ Ã…terstÃ¤ller analysresultat efter fÃ¶nsterbyte');
          setAnalysisResult(analysisResultRef.current);
        }
        
        // Ã…terstÃ¤ll filer frÃ¥n ref om de fÃ¶rsvunnit
        if (files.length === 0 && filesRef.current.length > 0) {
          console.log('ðŸ”„ Ã…terstÃ¤ller filer efter fÃ¶nsterbyte');
          setFiles(filesRef.current);
        }
      }
    };
    
    const handleFocus = () => {
      // Ã…terstÃ¤ll Ã¤ven vid focus-event fÃ¶r extra sÃ¤kerhet
      if (!analysisResult && analysisResultRef.current) {
        console.log('ðŸ”„ Ã…terstÃ¤ller analysresultat efter focus');
        setAnalysisResult(analysisResultRef.current);
      }
    };
    
    document.addEventListener('visibilitychange', handleVisibilityChange);
    window.addEventListener('focus', handleFocus);
    
    return () => {
      document.removeEventListener('visibilitychange', handleVisibilityChange);
      window.removeEventListener('focus', handleFocus);
    };
  }, [analysisResult, files]);

  // Rapportera status-Ã¤ndringar till parent
  useEffect(() => {
    if (onImportStatusChange) {
      onImportStatusChange({
        hasFile: files.length > 0,
        isAnalyzing,
        hasResults: !!analysisResult
      });
    }
  }, [files, isAnalyzing, analysisResult, onImportStatusChange]);

  // Cleanup-funktion fÃ¶r att rensa localStorage
  const clearImportState = useCallback(() => {
    const success = handbookStorage.clearFormState();
    if (success) {
      console.log('ðŸ§¹ Rensade document import state frÃ¥n localStorage');
    }
  }, []);

  // Exponera cleanup-funktionen fÃ¶r parent-komponenter
  useEffect(() => {
    // LÃ¤gg till cleanup-funktionen pÃ¥ window-objektet sÃ¥ andra komponenter kan anvÃ¤nda den
    (window as any).clearDocumentImportState = clearImportState;
    
    return () => {
      delete (window as any).clearDocumentImportState;
    };
  }, [clearImportState]);

  const handleDrag = useCallback((e: React.DragEvent) => {
    e.preventDefault();
    e.stopPropagation();
    if (e.type === "dragenter" || e.type === "dragover") {
      setDragActive(true);
    } else if (e.type === "dragleave") {
      setDragActive(false);
    }
  }, []);

  const handleDrop = useCallback((e: React.DragEvent) => {
    e.preventDefault();
    e.stopPropagation();
    setDragActive(false);
    
    if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
      handleMultipleFileSelection(Array.from(e.dataTransfer.files));
    }
  }, []);

  const validateFile = useCallback((file: File): string | null => {
    const supportedFileTypes = [
      'application/pdf',
      'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
      'application/msword',
      'text/plain',
      'image/jpeg',
      'image/jpg', 
      'image/png',
      'image/gif',
      'image/webp'
    ];
    
    if (!supportedFileTypes.includes(file.type)) {
      return `${file.name}: Filtypen stÃ¶ds inte. TillÃ¥tna filtyper: PDF, Word, textfiler och bilder (JPG, PNG, GIF, WebP).`;
    }

    if (file.size > 10 * 1024 * 1024) { // 10MB limit
      return `${file.name}: Filen Ã¤r fÃ¶r stor. Maximal filstorlek Ã¤r 10MB.`;
    }
    
    return null;
  }, []);

  const handleMultipleFileSelection = useCallback((selectedFiles: File[]) => {
    // FÃ¶rhindra dubbelbearbetning
    if (isProcessingRef.current) return;
    
    const validFiles: File[] = [];
    const errors: string[] = [];
    
    selectedFiles.forEach(file => {
      const error = validateFile(file);
      if (error) {
        errors.push(error);
      } else {
        validFiles.push(file);
      }
    });
    
    if (errors.length > 0) {
      setError(errors.join('\n'));
      if (validFiles.length === 0) return;
    } else {
      setError(null);
    }
    
    setFiles(validFiles);
    setAnalysisResult(null);
    setCurrentFileIndex(0);
  }, [validateFile]);

  const handleFileSelection = useCallback((selectedFile: File) => {
    handleMultipleFileSelection([selectedFile]);
  }, [handleMultipleFileSelection]);

  const analyzeDocument = useCallback(async () => {
    if (files.length === 0 || isAnalyzing || isProcessingRef.current) return;
    
    isProcessingRef.current = true;
    setIsAnalyzing(true);
    setError(null);
    setAnalysisProgress(0);
    setCurrentFileIndex(0);

    try {
      const allSections: ImportedSection[] = [];
      let combinedMetadata: any = null;

      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        setCurrentFileIndex(i);
        
        // Steg 1: Ladda upp fil (snabbt steg)
        setAnalysisStep(`Laddar upp dokument ${i + 1}/${files.length}: ${file.name}...`);
        setAnalysisProgress((i / files.length) * 100 * 0.1); // Minska frÃ¥n 30% till 10%

        const formData = new FormData();
        formData.append('file', file);

        const uploadResponse = await fetch('/api/documents/upload', {
          method: 'POST',
          body: formData,
        });

        if (!uploadResponse.ok) {
          throw new Error(`Misslyckades med att ladda upp ${file.name}`);
        }

        const { fileId } = await uploadResponse.json();

        // Steg 2: Extrahera text
        setAnalysisStep(`Extraherar text frÃ¥n ${file.name}... (OCR fÃ¶r scannade dokument kan ta lÃ¤ngre tid)`);
        setAnalysisProgress((i / files.length) * 100 * 0.1 + 15); // Justerad timing

        const extractFormData = new FormData();
        extractFormData.append('fileId', fileId);
        
        const extractResponse = await fetch('/api/documents/extract-text', {
          method: 'POST',
          body: extractFormData,
        });

        if (!extractResponse.ok) {
          const errorData = await extractResponse.json();
          if (errorData.error && errorData.error.includes('scannad PDF')) {
            throw new Error(`${file.name} verkar vara en scannad PDF. OCR-bearbetning misslyckades. FÃ¶rsÃ¶k med en PDF som innehÃ¥ller text eller ett Word-dokument.`);
          }
          throw new Error(`Misslyckades med textextraktion fÃ¶r ${file.name}: ${errorData.error || 'OkÃ¤nt fel'}`);
        }

        const extractResult = await extractResponse.json();
        const text = extractResult.extractedText || extractResult.text || '';
        const metadata = {
          title: file.name,
          pages: extractResult.pages || 1,
          textLength: extractResult.textLength || text.length,
          extractionMethod: extractResult.success ? 'success' : 'fallback'
        };

        // Steg 3: AI-analys (lÃ¤ngre steg med mer tid)
        setAnalysisStep(`ðŸ¤– AI analyserar ${file.name}...`);
        setAnalysisProgress((i / files.length) * 100 * 0.1 + 30); // Startar vid 30% istÃ¤llet fÃ¶r 50%

        // Reduce logging frequency to prevent render loops  
        if (i === 0 || i === files.length - 1) { // Only log first and last file
          console.log('[DocumentImport] Skickar analyze-structure-anrop:', {
            fileIndex: i + 1,
            totalFiles: files.length,
            fileName: file.name,
            documentId: fileId
          });
        }

        const analysisResponse = await fetch('/api/documents/analyze-structure', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            text, 
            metadata: {
              ...metadata,
              title: `${metadata?.title || file.name} (Dokument ${i + 1})`
            },
            templateType: 'brf',
            documentId: fileId // <-- Skicka alltid med documentId!
          }),
        });

        if (!analysisResponse.ok) {
          const errorData = await analysisResponse.json();
          console.error(`âŒ [DocumentImport] Analysis failed for ${file.name}:`, errorData);
          
          // Hantera scannade PDF:er och andra fall dÃ¤r text inte kunde extraheras
          if (errorData.error?.includes('Inga giltiga sektioner') || 
              errorData.error?.includes('scannad PDF') ||
              errorData.error?.includes('Detta verkar vara en scannad PDF')) {
            console.log(`ðŸ“„ [DocumentImport] Detected scanned PDF: ${file.name}, creating placeholder sections`);
            
            // Skapa placeholder-sektioner fÃ¶r scannade dokument
            const placeholderSections = DEFAULT_HANDBOOK_TEMPLATE.map(section => ({
              content: `ðŸ“„ **Scannad PDF-fil:** ${file.name}

Detta dokument verkar vara en scannad PDF som innehÃ¥ller bilder istÃ¤llet fÃ¶r text. 

**FÃ¶r att lÃ¤gga till innehÃ¥ll frÃ¥n detta dokument:**

1. **OCR-konvertering:** AnvÃ¤nd Adobe Acrobat Pro eller liknande fÃ¶r att konvertera till sÃ¶kbar text
2. **Google Drive:** Ladda upp PDF:en till Google Drive - den konverteras automatiskt
3. **Online OCR:** AnvÃ¤nd verktyg som ocr.space eller onlineocr.net
4. **Manuell kopiering:** Kopiera texten manuellt frÃ¥n dokumentet

**Redigera denna sektion** fÃ¶r att lÃ¤gga till det faktiska innehÃ¥llet nÃ¤r du har konverterat dokumentet.`,
              title: files.length > 1 ? `${section.title} (${file.name})` : section.title,
              confidence: 0.2 // LÃ¥g confidence fÃ¶r placeholder
            }));
            
            allSections.push(...placeholderSections);
            console.log(`ðŸ“„ [DocumentImport] Added ${placeholderSections.length} placeholder sections for scanned PDF: ${file.name}`);
            continue; // FortsÃ¤tt med nÃ¤sta fil
          }
          
          if (errorData.fallback) {
            console.warn(`âš ï¸ [DocumentImport] Using fallback for ${file.name}: ${errorData.error}`);
            // Ã„ven med fallback, fÃ¶rsÃ¶k att extrahera nÃ¥got anvÃ¤ndbart
            if (errorData.sections && errorData.sections.length > 0) {
              const fallbackSections = errorData.sections.map((section: ImportedSection) => ({
                ...section,
                title: files.length > 1 ? `${section.title} (${file.name})` : section.title,
                confidence: 0.3 // LÃ¥g confidence fÃ¶r fallback
              }));
              allSections.push(...fallbackSections);
              console.log(`ðŸ”„ [DocumentImport] Added ${fallbackSections.length} fallback sections from ${file.name}`);
            }
            continue; // Hoppa Ã¶ver denna fil och fortsÃ¤tt med nÃ¤sta
          }
          throw new Error(`Misslyckades med AI-analys fÃ¶r ${file.name}: ${errorData.error || 'OkÃ¤nt fel'}`);
        }

        const result = await analysisResponse.json();
        
        // LÃ¤gg till sektioner frÃ¥n denna fil
        if (result.sections && result.sections.length > 0) {
          console.log(`ðŸ” [DocumentImport] File ${i + 1}/${files.length} (${file.name}) produced ${result.sections.length} sections`);
          // LÃ¤gg till filnamn som prefix till sektionstitlar fÃ¶r att undvika konflikter
          const sectionsWithPrefix = result.sections.map((section: ImportedSection) => ({
            ...section,
            title: files.length > 1 ? `${section.title} (${file.name})` : section.title
          }));
          allSections.push(...sectionsWithPrefix);
          console.log(`ðŸ” [DocumentImport] Total sections so far: ${allSections.length}`);
        } else {
          console.warn(`âš ï¸ [DocumentImport] File ${file.name} produced no sections`);
        }

        // Spara metadata frÃ¥n fÃ¶rsta filen
        if (i === 0) {
          combinedMetadata = metadata;
        }
      }

      // Skapa kombinerat resultat
      const combinedResult: AnalysisResult = {
        sections: allSections,
        metadata: {
          ...combinedMetadata,
          title: files.length > 1 ? `Kombinerat dokument (${files.length} filer)` : combinedMetadata?.title || files[0]?.name || 'OkÃ¤nt dokument',
          totalPages: files.length, // AnvÃ¤nd antal filer som "sidor"
          documentType: 'combined'
        }
      };

      // Steg 4: SlutfÃ¶r
      setAnalysisStep('FÃ¶rbereder import...');
      setAnalysisProgress(100);

      setAnalysisResult(combinedResult);

      showToast({
        title: "Analys slutfÃ¶rd",
        description: `Hittade ${allSections.length} sektioner frÃ¥n ${files.length} dokument.`,
      });

      // Automatiskt anropa onImportComplete nÃ¤r analysen Ã¤r klar
      console.log(`ðŸŽ¯ [DocumentImport] Auto-importing ${allSections.length} sections from ${files.length} files after analysis completion`);
      console.log('ðŸŽ¯ [DocumentImport] Final sections:', allSections.map(s => s.title));
      onImportComplete(allSections);

    } catch (err) {
      console.error('Fel vid dokumentanalys:', err);
      setError(err instanceof Error ? err.message : 'Ett ovÃ¤ntat fel intrÃ¤ffade');
      showToast({
        title: "Fel vid analys",
        description: "Kunde inte analysera dokumenten. FÃ¶rsÃ¶k igen.",
        variant: "destructive",
      });
    } finally {
      setIsAnalyzing(false);
      setAnalysisStep('');
      setAnalysisProgress(0);
      setCurrentFileIndex(0);
      isProcessingRef.current = false;
    }
  }, [files, isAnalyzing, onImportComplete]);

  const getConfidenceColor = (confidence: number) => {
    if (confidence >= 0.8) return 'bg-green-100 text-green-800';
    if (confidence >= 0.6) return 'bg-yellow-100 text-yellow-800';
    return 'bg-red-100 text-red-800';
  };

  return (
    <div className="space-y-4 md:space-y-6">
      <Card>
        <CardHeader className="pb-4">
          <CardTitle className="flex items-center gap-2 text-lg md:text-xl">
            <Brain className="h-5 w-5" />
            Smart handboksimport
          </CardTitle>
          <p className="text-sm text-muted-foreground">
            Ladda upp dokument â†’ AI skapar sektioner automatiskt
          </p>
        </CardHeader>
        <CardContent className="space-y-4 lg:space-y-6">
          {/* File Upload Area */}
          <div
            className={`
              border-2 border-dashed rounded-lg p-4 md:p-6 text-center transition-all duration-300 ease-in-out
              ${dragActive ? 'border-primary bg-primary/10 scale-[1.02] shadow-lg transform' : 'border-gray-300'}
              ${files.length > 0 ? 'border-green-500 bg-gradient-to-br from-green-50 to-emerald-50 shadow-sm' : ''}
              hover:border-gray-400 hover:bg-gray-50/50
            `}
            onDragEnter={handleDrag}
            onDragLeave={handleDrag}
            onDragOver={handleDrag}
            onDrop={handleDrop}
          >
            <div className="flex flex-col items-center space-y-3">
              {files.length > 0 ? (
                <>
                  <div className="relative">
                    <FileText className="h-10 w-10 md:h-12 md:w-12 text-green-600 animate-in zoom-in-50 duration-300" />
                    <div className="absolute -top-1 -right-1 w-4 h-4 bg-green-500 rounded-full flex items-center justify-center animate-in zoom-in-75 duration-300 delay-150">
                      <CheckCircle className="h-3 w-3 text-white" />
                    </div>
                  </div>
                  <div className="text-center space-y-2">
                    <p className="font-medium text-sm md:text-base">
                      {files.length === 1 ? files[0].name : `${files.length} filer valda`}
                    </p>
                    {files.length === 1 ? (
                      <p className="text-xs md:text-sm text-muted-foreground">
                        {(files[0].size / 1024 / 1024).toFixed(2)} MB
                      </p>
                    ) : (
                      <div className="space-y-1">
                        <p className="text-xs md:text-sm text-muted-foreground">
                          Total storlek: {(files.reduce((sum, f) => sum + f.size, 0) / 1024 / 1024).toFixed(2)} MB
                        </p>
                        <div className="max-h-20 overflow-y-auto text-xs text-muted-foreground">
                          {files.map((file, index) => (
                            <div key={index} className="truncate">
                              {file.name} ({(file.size / 1024 / 1024).toFixed(1)} MB)
                            </div>
                          ))}
                        </div>
                      </div>
                    )}
                  </div>
                </>
              ) : (
                <>
                  <div className="relative">
                    <Upload className="h-10 w-10 md:h-12 md:w-12 text-gray-400 transition-all duration-300 hover:text-gray-600 hover:scale-110" />
                    {dragActive && (
                      <div className="absolute inset-0 border-2 border-primary border-dashed rounded-full animate-ping"></div>
                    )}
                  </div>
                  <div className="text-center">
                    <p className="text-base md:text-lg font-medium">
                      Dra filer hit eller klicka
                    </p>
                    <p className="text-xs md:text-sm text-muted-foreground hidden md:block">
                      Flera filer tillÃ¥tna
                    </p>
                  </div>
                </>
              )}
              
              <input
                ref={fileInputRef}
                type="file"
                className="hidden"
                accept=".pdf,.docx,.doc,.txt"
                multiple
                onChange={(e) => e.target.files && handleMultipleFileSelection(Array.from(e.target.files))}
                id="file-upload"
              />
              <div className="flex gap-2">
                <Button 
                  type="button"
                  variant="outline" 
                  className="cursor-pointer text-sm md:text-base"
                  onClick={() => fileInputRef.current?.click()}
                  disabled={isAnalyzing || isLoading}
                >
                  {files.length > 0 ? 'VÃ¤lj fler filer' : 'VÃ¤lj filer'}
                </Button>
                {files.length > 0 && (
                  <Button 
                    type="button"
                    variant="ghost" 
                    size="sm"
                    className="text-xs text-muted-foreground hover:text-destructive"
                    onClick={() => {
                      setFiles([]);
                      setAnalysisResult(null);
                      setError(null);
                    }}
                    disabled={isAnalyzing || isLoading}
                  >
                    Rensa alla
                  </Button>
                )}
              </div>
              
              <div className="text-xs text-muted-foreground text-center px-2">
                <span className="block md:hidden">PDF, Word, bilder upp till 10MB</span>
                <span className="hidden md:block">StÃ¶der PDF (inklusive scannade dokument med OCR), Word (.docx), textfiler och bilder (JPG, PNG, GIF, WebP) upp till 10MB per fil</span>
              </div>
            </div>
          </div>

          {error && (
            <Alert variant="destructive">
              <AlertCircle className="h-4 w-4" />
              <AlertDescription className="text-sm">{error}</AlertDescription>
            </Alert>
          )}

          {/* ðŸŽ¯ TEST: Animation Preview Button */}
          {!isAnalyzing && !files.length && (
            <div className="text-center py-4">
              <button 
                onClick={() => {
                  setIsAnalyzing(true);
                  setAnalysisProgress(45);
                  setAnalysisStep("ðŸŽ¨ FÃ¶rhandsgranskning av animation...");
                  setTimeout(() => {
                    setIsAnalyzing(false);
                    setAnalysisProgress(0);
                  }, 5000);
                }}
                className="px-6 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-full font-semibold hover:from-purple-600 hover:to-pink-600 transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105"
              >
                ðŸŽ¬ FÃ¶rhandsgranska Premium Animation
              </button>
            </div>
          )}

          {/* âœ¨ AI Magiska Bearbetning - Premium Design */}
          {(isAnalyzing || (analysisResult && analysisResult.sections.length > 0)) && (
            <Card className="border-none bg-gradient-to-br from-blue-50 via-indigo-50 via-purple-50 to-violet-50 relative overflow-hidden shadow-2xl">
              {/* Premium Floating Elements */}
              <div className="absolute inset-0 overflow-hidden">
                {/* Gradient orbs */}
                <div className="absolute top-4 left-8 w-8 h-8 bg-gradient-to-r from-blue-400 to-cyan-400 rounded-full opacity-30 animate-float blur-sm" style={{ animationDelay: '0s' }}></div>
                <div className="absolute top-16 right-12 w-6 h-6 bg-gradient-to-r from-indigo-400 to-purple-400 rounded-full opacity-25 animate-float blur-sm" style={{ animationDelay: '1s' }}></div>
                <div className="absolute bottom-12 left-16 w-10 h-10 bg-gradient-to-r from-purple-400 to-pink-400 rounded-full opacity-20 animate-float blur-sm" style={{ animationDelay: '2s' }}></div>
                <div className="absolute bottom-6 right-8 w-4 h-4 bg-gradient-to-r from-cyan-400 to-blue-400 rounded-full opacity-35 animate-float blur-sm" style={{ animationDelay: '0.5s' }}></div>
                
                {/* Sparkle effects */}
                <div className="absolute top-8 left-1/4 w-2 h-2 bg-white rounded-full opacity-70 animate-ping" style={{ animationDelay: '0.3s' }}></div>
                <div className="absolute top-1/3 right-1/4 w-1.5 h-1.5 bg-white rounded-full opacity-60 animate-ping" style={{ animationDelay: '1.2s' }}></div>
                <div className="absolute bottom-1/3 left-1/3 w-1 h-1 bg-white rounded-full opacity-80 animate-ping" style={{ animationDelay: '2.1s' }}></div>
                
                {/* Glowing lines */}
                <div className="absolute top-0 left-0 w-full h-px bg-gradient-to-r from-transparent via-blue-400 to-transparent opacity-40 animate-pulse"></div>
                <div className="absolute bottom-0 left-0 w-full h-px bg-gradient-to-r from-transparent via-purple-400 to-transparent opacity-40 animate-pulse" style={{ animationDelay: '1s' }}></div>
              </div>
              
              <CardContent className="pt-8 pb-8 relative z-10">
                <div className="space-y-6">
                  {/* Premium status header */}
                  <div className="text-center space-y-3">
                    <div className="relative mx-auto w-16 h-16">
                      <div className="absolute inset-0 bg-gradient-to-r from-blue-500 via-indigo-500 to-purple-500 rounded-full animate-spin opacity-20"></div>
                      <div className="absolute inset-2 bg-gradient-to-r from-blue-600 via-indigo-600 to-purple-600 rounded-full flex items-center justify-center shadow-xl">
                        <Brain className="h-8 w-8 text-white animate-pulse" />
                      </div>
                      <div className="absolute inset-0 bg-gradient-to-r from-blue-400 to-purple-400 rounded-full opacity-30 animate-ping"></div>
                    </div>
                    <div className="flex items-center justify-between w-full">
                      <div>
                        <h3 className="text-xl font-bold bg-gradient-to-r from-blue-700 via-indigo-700 to-purple-700 bg-clip-text text-transparent">
                          {isAnalyzing ? 'ðŸª„ AI Magiska Handbok-skapare' : 'âœ¨ Analys slutfÃ¶rd'}
                        </h3>
                        <p className="text-sm text-blue-600 mt-1">
                          {isAnalyzing ? analysisStep : `ðŸŽ‰ Hittade ${analysisResult?.sections?.length || 0} sektioner i dina dokument!`}
                        </p>
                      </div>
                      {!isAnalyzing && analysisResult && analysisResult.sections.length > 0 && (
                        <button
                          onClick={() => setIsResultsCollapsed(!isResultsCollapsed)}
                          className="ml-4 p-2 hover:bg-white/50 rounded-full transition-colors duration-200"
                        >
                          <svg 
                            className={`w-5 h-5 text-indigo-600 transition-transform duration-200 ${isResultsCollapsed ? 'rotate-180' : ''}`} 
                            fill="none" 
                            stroke="currentColor" 
                            viewBox="0 0 24 24"
                          >
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                          </svg>
                        </button>
                      )}
                    </div>
                  </div>
                  
                  {/* Ultra-premium progress bar */}
                  {(isAnalyzing || !isResultsCollapsed) && (
                  <div className="space-y-3">
                    <div className="relative p-1 bg-gradient-to-r from-blue-200 via-indigo-200 to-purple-200 rounded-full">
                      <div className="relative bg-white rounded-full p-1">
                        <div className="relative h-6 bg-gray-100 rounded-full overflow-hidden">
                          <div 
                            className="absolute top-0 left-0 h-full bg-gradient-to-r from-blue-500 via-indigo-500 via-purple-500 to-pink-500 rounded-full transition-all duration-700 ease-out shadow-lg"
                            style={{ 
                              width: `${isAnalyzing ? analysisProgress : 100}%`,
                              boxShadow: '0 0 20px rgba(99, 102, 241, 0.6), inset 0 0 20px rgba(255, 255, 255, 0.3)'
                            }}
                          >
                            <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white to-transparent opacity-40 animate-pulse"></div>
                            <div className="absolute inset-0 bg-gradient-to-t from-transparent to-white opacity-30"></div>
                          </div>
                          {/* Progress indicator */}
                          <div 
                            className="absolute top-1/2 transform -translate-y-1/2 w-4 h-4 bg-white rounded-full shadow-lg border-2 border-indigo-400 transition-all duration-700"
                            style={{ 
                              left: `calc(${isAnalyzing ? analysisProgress : 100}% - 8px)`,
                              boxShadow: '0 0 10px rgba(99, 102, 241, 0.8)'
                            }}
                          >
                            <div className="absolute inset-1 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full animate-pulse"></div>
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    <div className="flex justify-between items-center">
                      <span className="text-sm font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
                        {isAnalyzing ? `${Math.round(analysisProgress)}% Klart` : '100% Komplett!'}
                      </span>
                      <span className="text-sm font-medium text-indigo-600 animate-pulse">
                        {isAnalyzing ? (
                          analysisProgress < 15 ? 'ðŸš€ Startar motor...' : 
                          analysisProgress < 30 ? 'ðŸ“– LÃ¤ser din handbok...' : 
                          analysisProgress < 60 ? 'ðŸ§  AI tÃ¤nker kreativt...' : 
                          analysisProgress < 85 ? 'âœ¨ Skapar magi...' : 
                          'ðŸŽ‰ NÃ¤stan fÃ¤rdig!'
                        ) : 'ðŸŽŠ Redo att skapa handbok!'}
                      </span>
                    </div>
                  </div>
                  
                  {/* Multi-file luxury indicator */}
                  {files.length > 1 && (
                    <div className="bg-white/80 backdrop-blur-sm rounded-xl p-4 border border-white/50 shadow-xl">
                      <div className="flex items-center gap-3 text-sm text-indigo-700">
                        <div className="relative">
                          <FileText className="h-5 w-5" />
                          <div className="absolute -top-1 -right-1 w-3 h-3 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full animate-bounce text-xs text-white flex items-center justify-center font-bold">
                            {files.length}
                          </div>
                        </div>
                        <span className="font-semibold">
                          Bearbetar fil {currentFileIndex + 1} av {files.length}
                        </span>
                      </div>
                      {/* Luxe file progress */}
                      <div className="mt-3 flex gap-2">
                        {Array.from({ length: files.length }).map((_, index) => (
                          <div
                            key={index}
                            className={`h-2 flex-1 rounded-full transition-all duration-500 shadow-sm ${
                              index < currentFileIndex ? 'bg-gradient-to-r from-green-400 to-emerald-500 shadow-green-200' :
                              index === currentFileIndex ? 'bg-gradient-to-r from-blue-500 to-purple-500 animate-pulse shadow-blue-200' :
                              'bg-gray-200'
                            }`}
                          />
                        ))}
                      </div>
                    </div>
                  )}
                  
                  {/* Premium processing steps */}
                  <div className="grid grid-cols-3 gap-4">
                    <div className={`relative p-4 rounded-xl transition-all duration-700 transform ${
                      analysisProgress > 0 ? 'bg-gradient-to-br from-blue-100 to-cyan-100 text-blue-700 scale-105 shadow-lg' : 'bg-gray-100 text-gray-400 scale-95'
                    }`}>
                      <div className="text-center space-y-2">
                        <div className="relative mx-auto w-8 h-8">
                          <Upload className={`h-8 w-8 mx-auto ${analysisProgress > 0 && analysisProgress < 15 ? 'animate-bounce' : ''}`} />
                          {analysisProgress > 0 && analysisProgress < 15 && (
                            <div className="absolute inset-0 bg-blue-400 rounded-full opacity-30 animate-ping"></div>
                          )}
                        </div>
                        <div className="text-xs font-bold">Laddar upp</div>
                        {analysisProgress > 15 && (
                          <div className="absolute -top-1 -right-1 w-4 h-4 bg-green-500 rounded-full flex items-center justify-center">
                            <span className="text-white text-xs">âœ“</span>
                          </div>
                        )}
                      </div>
                    </div>
                    
                    <div className={`relative p-4 rounded-xl transition-all duration-700 transform ${
                      analysisProgress > 15 ? 'bg-gradient-to-br from-indigo-100 to-purple-100 text-indigo-700 scale-105 shadow-lg' : 'bg-gray-100 text-gray-400 scale-95'
                    }`}>
                      <div className="text-center space-y-2">
                        <div className="relative mx-auto w-8 h-8">
                          <Brain className={`h-8 w-8 mx-auto ${analysisProgress > 15 && analysisProgress < 85 ? 'animate-pulse' : ''}`} />
                          {analysisProgress > 15 && analysisProgress < 85 && (
                            <div className="absolute inset-0 bg-indigo-400 rounded-full opacity-30 animate-ping"></div>
                          )}
                        </div>
                        <div className="text-xs font-bold">AI-analys</div>
                        {analysisProgress > 85 && (
                          <div className="absolute -top-1 -right-1 w-4 h-4 bg-green-500 rounded-full flex items-center justify-center">
                            <span className="text-white text-xs">âœ“</span>
                          </div>
                        )}
                      </div>
                    </div>
                    
                    <div className={`relative p-4 rounded-xl transition-all duration-700 transform ${
                      analysisProgress > 85 ? 'bg-gradient-to-br from-purple-100 to-pink-100 text-purple-700 scale-105 shadow-lg' : 'bg-gray-100 text-gray-400 scale-95'
                    }`}>
                      <div className="text-center space-y-2">
                        <div className="relative mx-auto w-8 h-8">
                          <CheckCircle className={`h-8 w-8 mx-auto ${analysisProgress > 85 ? 'animate-bounce' : ''}`} />
                          {analysisProgress > 85 && (
                            <div className="absolute inset-0 bg-purple-400 rounded-full opacity-30 animate-ping"></div>
                          )}
                        </div>
                        <div className="text-xs font-bold">FÃ¤rdig!</div>
                        {analysisProgress >= 100 && (
                          <div className="absolute -top-1 -right-1 w-4 h-4 bg-green-500 rounded-full flex items-center justify-center animate-bounce">
                            <span className="text-white text-xs">ðŸŽ‰</span>
                          </div>
                        )}
                      </div>
                    </div>
                  </div>
                  
                  {/* Magic loading message */}
                  <div className="text-center bg-white/60 backdrop-blur-sm rounded-lg p-3">
                    <div className="text-sm font-semibold bg-gradient-to-r from-blue-600 via-indigo-600 to-purple-600 bg-clip-text text-transparent animate-pulse">
                      {analysisProgress < 20 ? 'ðŸ”® Ã–ppnar din handbok med magi...' :
                       analysisProgress < 40 ? 'ðŸ“œ Extraherar hemligheter frÃ¥n texten...' :
                       analysisProgress < 60 ? 'ðŸ§™â€â™‚ï¸ AI-trollkarlen arbetar intensivt...' :
                       analysisProgress < 80 ? 'âœ¨ Skapar perfekta sektioner...' :
                       'ðŸ† MÃ¤sterverk nÃ¤stan klart!'}
                    </div>
                  </div>
                </div>
              </CardContent>
            </Card>
          )}

          {/* Analysis Results */}
          {analysisResult && !isAnalyzing && (
            <Card className="border-green-200 bg-gradient-to-br from-green-50 via-emerald-50 to-teal-50 relative overflow-hidden animate-in slide-in-from-top-4 duration-500">
              {/* Success celebration particles */}
              <div className="absolute inset-0 opacity-30">
                <div className="absolute top-4 left-8 w-2 h-2 bg-green-400 rounded-full animate-ping" style={{ animationDelay: '0s' }}></div>
                <div className="absolute top-6 right-12 w-1.5 h-1.5 bg-emerald-400 rounded-full animate-ping" style={{ animationDelay: '0.3s' }}></div>
                <div className="absolute bottom-8 left-16 w-1 h-1 bg-teal-400 rounded-full animate-ping" style={{ animationDelay: '0.6s' }}></div>
                <div className="absolute bottom-4 right-8 w-2 h-2 bg-green-300 rounded-full animate-ping" style={{ animationDelay: '0.9s' }}></div>
              </div>
              
              <CardHeader className="pb-3 relative z-10">
                <CardTitle className="flex items-center gap-3 text-green-800 text-lg">
                  <div className="relative">
                    <CheckCircle className="h-6 w-6 animate-in zoom-in-50 duration-300" />
                    <div className="absolute inset-0 h-6 w-6 bg-green-400 rounded-full animate-ping opacity-50"></div>
                  </div>
                  <span className="animate-in slide-in-from-left-2 duration-300 delay-150">
                    âœ¨ Analys slutfÃ¶rd
                  </span>
                </CardTitle>
              </CardHeader>
              <CardContent className="space-y-4">
                <div>
                  <div className="flex items-center gap-2 mb-3">
                    <h4 className="font-medium">Identifierade sektioner ({analysisResult.sections.length}):</h4>
                    <div className="group relative">
                      <Info className="h-4 w-4 text-gray-400 cursor-help" />
                      <div className="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-900 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none whitespace-nowrap z-10">
                        Procentsatsen visar hur sÃ¤ker AI:n Ã¤r pÃ¥ identifieringen
                        <div className="absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-gray-900"></div>
                      </div>
                    </div>
                  </div>
                  <div className="space-y-3">
                    {analysisResult.sections.map((section, index) => (
                      <div key={index} className="p-4 bg-white rounded-lg border shadow-sm">
                        <div className="flex items-start justify-between mb-2">
                          <h5 className="font-medium text-base break-words pr-2">{section.title}</h5>
                          <div className="flex items-center gap-1 flex-shrink-0">
                            <Badge variant="outline" className={`${getConfidenceColor(section.confidence)}`}>
                              {Math.round(section.confidence * 100)}%
                            </Badge>
                          </div>
                        </div>
                        <p className="text-sm text-muted-foreground mb-2 leading-relaxed">
                          {section.content.length > 200 
                            ? section.content.substring(0, 200) + '...' 
                            : section.content
                          }
                        </p>
                        {section.suggestedMapping && (
                          <div className="flex items-center gap-1 text-sm text-blue-600">
                            <span>â†’</span>
                            <span className="font-medium">{section.suggestedMapping}</span>
                          </div>
                        )}
                      </div>
                    ))}
                  </div>
                </div>
              </CardContent>
            </Card>
          )}

          {/* Action Buttons */}
          <div className="flex flex-col sm:flex-row gap-2 justify-end">
            {files.length > 0 && !analysisResult && !isAnalyzing && (
              <Button 
                type="button"
                onClick={analyzeDocument} 
                disabled={isAnalyzing || isLoading}
                className="flex items-center justify-center gap-2 w-full sm:w-auto bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-semibold py-3 px-6 rounded-lg shadow-lg ring-2 ring-blue-300 ring-opacity-50 transition-all duration-200 transform hover:scale-105"
                size="lg"
              >
                <Brain className="h-5 w-5" />
                âœ¨ Skapa handbok med AI
                {files.length > 1 && (
                  <span className="ml-1 text-xs bg-white/20 px-2 py-1 rounded">
                    {files.length} filer
                  </span>
                )}
              </Button>
            )}
          </div>
        </CardContent>
      </Card>
    </div>
  );
}); 