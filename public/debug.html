<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CORS Diagnostik - Handbok.org</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      line-height: 1.5;
      margin: 0;
      padding: 20px;
      color: #333;
      background-color: #f5f5f5;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      padding: 20px;
    }
    h1 {
      margin-top: 0;
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
    }
    h2 {
      margin-top: 1.5em;
    }
    .test-section {
      margin: 1em 0;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .test-result {
      margin-top: 10px;
      padding: 10px;
      border-radius: 4px;
    }
    .success {
      background-color: #d4edda;
      color: #155724;
    }
    .error {
      background-color: #f8d7da;
      color: #721c24;
    }
    .button {
      background-color: #0070f3;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }
    .button:hover {
      background-color: #0051a8;
    }
    pre {
      background: #f8f8f8;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
    }
    .status {
      font-weight: bold;
    }
    .fix-button {
      background-color: #38a169;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 10px;
    }
    .fix-button:hover {
      background-color: #2f855a;
    }
    .info {
      background-color: #e9f5fe;
      border-left: 4px solid #3182ce;
      padding: 10px;
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>CORS Diagnostik - Handbok.org</h1>
    
    <div class="info">
      <p>Detta verktyg hjälper till att diagnostisera och åtgärda CORS-relaterade problem som kan uppstå på subdomäner.</p>
      <p>Subdomän: <span id="current-subdomain">Identifierar...</span></p>
    </div>
    
    <h2>Resurstester</h2>
    
    <div class="test-section">
      <h3>JSON Test</h3>
      <button id="test-json" class="button">Kör test</button>
      <div id="json-result" class="test-result"></div>
    </div>
    
    <div class="test-section">
      <h3>CSS Test</h3>
      <button id="test-css" class="button">Kör test</button>
      <div id="css-result" class="test-result"></div>
    </div>
    
    <div class="test-section">
      <h3>API Proxy Test</h3>
      <button id="test-api-proxy" class="button">Kör test</button>
      <div id="api-proxy-result" class="test-result"></div>
    </div>
    
    <div id="fix-section" style="margin-top: 30px; display: none;">
      <h2>Åtgärda problem</h2>
      <p>Vi har identifierat potentiella CORS-problem. Klicka på knappen nedan för att försöka åtgärda dem:</p>
      <button id="apply-fix" class="fix-button">Åtgärda CORS-problem</button>
      <div id="fix-result" class="test-result"></div>
    </div>
    
    <div style="margin-top: 30px;">
      <h2>Navigering</h2>
      <div style="display: flex; gap: 10px;">
        <a href="/" class="button" style="text-decoration: none;">Tillbaka till startsidan</a>
        <a href="javascript:window.location.reload()" class="button" style="background-color: #6b7280; text-decoration: none;">Ladda om sidan</a>
      </div>
    </div>
  </div>

  <script>
    // Identifiera subdomän
    function identifySubdomain() {
      const hostname = window.location.hostname;
      const subdomainElement = document.getElementById('current-subdomain');
      
      if (hostname === 'localhost') {
        subdomainElement.textContent = 'localhost (utveckling)';
      } else if (hostname.includes('vercel.app')) {
        subdomainElement.textContent = hostname + ' (Vercel)';
      } else if (hostname === 'handbok.org' || hostname === 'www.handbok.org') {
        subdomainElement.textContent = hostname + ' (huvuddomän)';
      } else if (hostname.endsWith('.handbok.org')) {
        const subdomain = hostname.split('.')[0];
        subdomainElement.textContent = subdomain + ' (subdomän)';
        
        // Visa fixsektion på subdomäner
        document.getElementById('fix-section').style.display = 'block';
      } else {
        subdomainElement.textContent = hostname + ' (okänd)';
      }
    }
    
    // Test JSON endpoint
    async function testJson() {
      const resultElement = document.getElementById('json-result');
      resultElement.innerHTML = '<p>Testar JSON endpoint...</p>';
      resultElement.className = 'test-result';
      
      try {
        const response = await fetch('/api/diagnosis');
        
        if (!response.ok) {
          throw new Error(`HTTP error ${response.status}`);
        }
        
        const data = await response.json();
        
        resultElement.innerHTML = '<p class="status">JSON Test Successful</p><pre>' + 
          JSON.stringify(data, null, 2) + '</pre>';
        resultElement.className = 'test-result success';
      } catch (error) {
        resultElement.innerHTML = '<p class="status">JSON Test Failed</p><p>Error: ' + 
          error.message + '</p>';
        resultElement.className = 'test-result error';
      }
    }
    
    // Test CSS loading
    function testCss() {
      const resultElement = document.getElementById('css-result');
      resultElement.innerHTML = '<p>Testar CSS-laddning...</p>';
      resultElement.className = 'test-result';
      
      // Create a test element
      const testElement = document.createElement('div');
      testElement.className = 'testElement';
      testElement.textContent = 'Test Element';
      document.body.appendChild(testElement);
      
      // Try to load a CSS file
      const link = document.createElement('link');
      link.rel = 'stylesheet';
      link.href = '/_next/static/css/test.css';
      
      // Add success/error handlers
      link.onload = () => {
        resultElement.innerHTML = '<p class="status">CSS Test Successful</p>' +
          '<p>CSS-filen laddades utan problem.</p>';
        resultElement.className = 'test-result success';
      };
      
      link.onerror = () => {
        resultElement.innerHTML = '<p class="status">CSS Test Failed</p>' +
          '<p>Error: Failed to load CSS</p>';
        resultElement.className = 'test-result error';
      };
      
      document.head.appendChild(link);
      
      // Set timeout in case neither event fires
      setTimeout(() => {
        // Check if the test element got styled
        const testElementStyle = window.getComputedStyle(testElement);
        if (testElementStyle.backgroundColor === 'rgb(240, 240, 240)') {
          resultElement.innerHTML = '<p class="status">CSS Test Successful</p>' +
            '<p>CSS laddades och tillämpades korrekt.</p>';
          resultElement.className = 'test-result success';
        } else if (resultElement.className !== 'test-result success') {
          resultElement.innerHTML = '<p class="status">CSS Test Failed</p>' +
            '<p>Error: CSS laddades inte eller tillämpades inte.</p>';
          resultElement.className = 'test-result error';
        }
        
        // Clean up
        document.body.removeChild(testElement);
      }, 2000);
    }
    
    // Test API proxy
    async function testApiProxy() {
      const resultElement = document.getElementById('api-proxy-result');
      resultElement.innerHTML = '<p>Testar API proxy...</p>';
      resultElement.className = 'test-result';
      
      try {
        // Try to load a CSS file through the proxy
        const cssUrl = '/_next/static/css/bb2534fb94d47e9a.css';
        const proxyUrl = `/api/resources?path=${encodeURIComponent(cssUrl)}`;
        
        const response = await fetch(proxyUrl);
        
        if (!response.ok) {
          throw new Error(`HTTP error ${response.status}`);
        }
        
        // Check if the content is CSS
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('text/css')) {
          resultElement.innerHTML = '<p class="status">API Proxy Test Successful</p>' +
            '<p>Proxy-endpointen fungerar korrekt för statiska resurser.</p>';
          resultElement.className = 'test-result success';
        } else {
          resultElement.innerHTML = '<p class="status">API Proxy Test Warning</p>' +
            '<p>Proxy svarade med oväntad Content-Type: ' + contentType + '</p>';
          resultElement.className = 'test-result warning';
        }
      } catch (error) {
        const errorHtml = `
            <p class="status">API Proxy Test Failed</p>
            <p>Error: ${error.message}</p>
            <p>URL: https://${window.location.hostname}/api/resources?path=/_next/static/css/bb2534fb94d47e9a.css</p>
            <p>Proxy endpoint might not be deployed yet or is not functioning correctly.</p>
          `;
        resultElement.innerHTML = errorHtml;
        resultElement.className = 'test-result error';
      }
    }
    
    // Apply fix
    function applyFix() {
      const resultElement = document.getElementById('fix-result');
      resultElement.innerHTML = '<p>Tillämpar CORS-fix...</p>';
      resultElement.className = 'test-result';
      
      try {
        // Add the static resource fix script
        const script = document.createElement('script');
        script.src = '/static-resource-fix.js';
        script.onload = () => {
          resultElement.innerHTML = `
          <p class="status">Direct Fix Applied</p>
          <p>
          - Overridden fetch to redirect through proxy
          - Fixed existing script/link tags
          - Set up MutationObserver for new elements
          </p>
          <p>Now try loading the main site again in a new tab. The CORS errors should be fixed.</p>
          `;
          resultElement.className = 'test-result success';
        };
        
        script.onerror = () => {
          resultElement.innerHTML = `
          <p class="status">Fix Failed</p>
          <p>Error: Could not load static-resource-fix.js</p>
          <p>Try refreshing the page or contacting support.</p>
          `;
          resultElement.className = 'test-result error';
        };
        
        document.head.appendChild(script);
      } catch (error) {
        resultElement.innerHTML = `
        <p class="status">Fix Failed</p>
        <p>Error: ${error.message}</p>
        `;
        resultElement.className = 'test-result error';
      }
    }
    
    // Set up event listeners
    document.addEventListener('DOMContentLoaded', () => {
      identifySubdomain();
      
      document.getElementById('test-json').addEventListener('click', testJson);
      document.getElementById('test-css').addEventListener('click', testCss);
      document.getElementById('test-api-proxy').addEventListener('click', testApiProxy);
      document.getElementById('apply-fix').addEventListener('click', applyFix);
    });
  </script>
</body>
</html> 